<html>

	<head>
		<title>Interactive Computer Music</title>

		<!--Vexflow-->
		<script src="js/jquery-1.6.2.min.js"></script>
		<script src="js/vexflow.js"></script>
	    <script src="bootstrap/js/bootstrap.min.js"></script>

		<link href="style.css" rel="stylesheet" type="text/css">

		<script language="javascript">

			/*
			 * Inputs: note   --- a string of the note to play, such as 'A'
			 * 		   length --- the number of seconds to play the note
			 *
			 * Plays a specified note for a certain length of time.
			 */
			function playNote(source, note, length) {
				//var source = myAudioContext.createOscillator();
				//source.type = 1; 
				source.frequency.value = note;
				//source.connect(myAudioContext.destination);
				source.start(myAudioContext.currentTime);
				//source.stop(myAudioContext.currentTime + length);
			}

			/*
			 * Inputs: duration --- the interval at which to call the function
			 * 		   fn       --- the function to call
			 *
			 * Replaces setTimeout() with a more accurate version.
			 */
			function interval(duration, fn) {
				this.baseline = undefined
				this.run = function() {
				    if (this.baseline === undefined) {
				    	this.baseline = new Date().getTime();
				    }
				    fn();
				    var end = new Date().getTime();
				    this.baseline += duration;
				    var nextTick = duration - (end - this.baseline);
				    if (nextTick < 0) {
				      nextTick = 0;
				    }
				    (function(i) {
				        i.timer = setTimeout(function() {
				        	i.run(end);
				      	}, nextTick)
				    }) (this)
			  	}
				this.stop = function() {
			   		clearTimeout(this.timer);
			 	}
			}

			/*
			 * Inputs: note --- the string representation of a note
			 *
			 * Returns the frequency of the note.
			 */
			 function noteToFrequency(note) {
			 	switch (note) {
			 		case "C":
			 			return 261.63;
			 		case "C#":
			 			return 277.18;
			 		case "Db":
			 			return 277.18;
			 		case "D":
			 			return 293.66;
			 		case "D#":
			 			return 311.13;
			 		case "Eb":
			 			return 311.13;
			 		case "E":
			 			return 329.63;
			 		case "Fb":
			 			return 329.63;
			 		case "F":
			 			return 349.23;
			 		case "F#":
			 			return 369.99;
			 		case "Gb":
			 			return 369.99;
			 		case "G":
			 			return 392.00;
			 		case "G#":
			 			return 415.30;
			 		case "Ab":
			 			return 415.30;
			 		case "A":
			 			return 440.00;
			 		case "A#":
			 			return 466.16;
			 		case "Bb":
			 			return 466.16;
			 		case "B":
			 			return 493.88;
			 		case "Cb":
			 			return 493.88;
			 	}
			 }

			 /*
			  * Start the music.
			  */
			 function start() {
			 	timer.run();
		    	timer2.run();
			 }

			 /*
			  * Remove a note from the list of available notes.
			  */
			 function remove_note() {
			 	notes.pop();
			 }

			 /*
			  * Draw notes on the canvas.
			  */
			function draw_note(note) {
			  // Clear the staff.
			  ctx.clear();
		      var stave = new Vex.Flow.Stave(10, 0, 100);
		      stave.addClef("treble").setContext(ctx).draw();
		      // Convert note.
			  var new_note = new Vex.Flow.StaveNote({ keys: [note.toLowerCase() + "/4"], duration: "q" });
			  var staff_notes = [];
			  // Play note.
			  if (note.length == 1) {
			    staff_notes[0] = new_note;
			  }
			  else {
			  	if (note.substring(1) == "#") {
			  		staff_notes[0] = new_note.addAccidental(0, new Vex.Flow.Accidental("#"));
			  	}
			  	else {
			  		staff_notes[0] = new_note.addAccidental(0, new Vex.Flow.Accidental("b"));
			  	}
			  }
			  // Create a voice in 1/4 for now.
			  var voice = new Vex.Flow.Voice({
			    num_beats: 1,
			    beat_value: 4,
			    resolution: Vex.Flow.RESOLUTION
			  });
			  // Add notes to voice
			  voice.addTickables(staff_notes);
			  // Format and justify the notes to 500 pixels
			  var formatter = new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 500);
			  // Render voice
			  voice.draw(ctx, stave);
			}

		</script>

		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">

	</head>

	<body>

	    <script langugae="javascript">

	    </script>

	    <h1>Interactive Computer Music</h1>

		<br>

	    <div class="hero-unit">

	    	<p id="textelement">Note: </p>
	    	<canvas id="score" width="700" height="100"></canvas>
	    	<br>
	    	Volume<br>
	    	<input id="volume" type="range" min="0" max="1" step="0.001" value="0.5"/>
	    	<br>
			<button class="btn btn-large btn-primary" type="button" onclick="start()">Start</button>
			<button class="btn btn-large btn-primary" type="button" onclick="remove_note()">Remove Note</button>

		</div>

		<br>

		&nbsp;&nbsp;A project by Peter Washington at Rice University.

		<script langugae="javascript">

			if ('webkitAudioContext' in window) {
	    		var myAudioContext = new webkitAudioContext();
			}
			else {
				alert("Sorry - this app requires an updated version of Chrome or Safari!");
			}

			var notes = ["A", "B", "C#", "D", "E", "F#", "G#"];

			var gainNode = myAudioContext.createGainNode();
			var source1 = myAudioContext.createOscillator();
			source1.type = 1; 
			var source2 = myAudioContext.createOscillator();
			source2.type = 1; 

			source1.connect(gainNode);
			source2.connect(gainNode);

			gainNode.connect(myAudioContext.destination);

			document.getElementById('volume').addEventListener('change', function() {
			    gainNode.gain.value = this.value;
			});

			var timer = new interval(1000, function() {
				var note = notes[Math.floor(Math.random() * notes.length)];
		    	playNote(source1, noteToFrequency(note), 1);
		    	document.getElementById("textelement").innerHTML = "Note: " + note;
		    	draw_note(note);
		    });

		    var timer2 = new interval(1000, function() {
		    	playNote(source2, noteToFrequency("A"), 1);
		    }); 

		    // Music notation.
		    var canvas = $("#score")[0];
		    var renderer = new Vex.Flow.Renderer(canvas, Vex.Flow.Renderer.Backends.CANVAS);
		    var ctx = renderer.getContext();
		    var stave = new Vex.Flow.Stave(10, 0, 100);
		    stave.addClef("treble").setContext(ctx).draw();

		</script>

	</body>

</html>