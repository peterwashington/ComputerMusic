
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>

 <title>Interactive Computer Music</title>

 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <!-- midi.js package -->
 <script src="./js/MIDI/AudioDetect.js" type="text/javascript"></script>
 <script src="./js/MIDI/LoadPlugin.js" type="text/javascript"></script>
 <script src="./js/MIDI/Plugin.js" type="text/javascript"></script>
 <script src="./js/MIDI/Player.js" type="text/javascript"></script>
 <script src="./js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
 <script src="./js/Window/DOMLoader.script.js" type="text/javascript"></script>
 <!-- extras -->
 <script src="./inc/Base64.js" type="text/javascript"></script>
 <script src="./inc/base64binary.js" type="text/javascript"></script>
 <!--Vexflow-->
 <script src="js/vexflow.js"></script>
 <script src="bootstrap/js/bootstrap.min.js"></script>

 <script src="js/jquery-1.6.2.min.js"></script>

 <link href="style.css" rel="stylesheet" type="text/css">

 <script type="text/javascript">

 	/*
	 * Inputs: duration --- the interval at which to call the function
	 * 		   fn       --- the function to call
	 *
	 * Replaces setTimeout() with a more accurate version.
	 */
	function interval(duration, fn) {
		this.baseline = undefined
		this.run = function() {
		    if (this.baseline === undefined) {
		    	this.baseline = new Date().getTime();
		    }
		    fn();
		    var end = new Date().getTime();
		    this.baseline += duration;
		    var nextTick = duration - (end - this.baseline);
		    if (nextTick < 0) {
		      nextTick = 0;
		    }
		    (function(i) {
		        i.timer = setTimeout(function() {
		        	i.run(end);
		      	}, nextTick)
		    }) (this)
	  	}
		this.end = function() {
	   		clearTimeout(this.timer);
	 	}
	}


 	/*
	 * Inputs: note --- the string representation of a note
	 *
	 * Returns the frequency of the note.
	 */
	 function noteToMIDI(note) {
	 	switch (note) {
	 		case "C4":
	 			return 48;
	 		case "C#4":
	 			return 49;
	 		case "Db4":
	 			return 49;
	 		case "D4":
	 			return 50;
	 		case "D#4":
	 			return 51;
	 		case "Eb4":
	 			return 51;
	 		case "E4":
	 			return 52;
	 		case "Fb4":
	 			return 52;
	 		case "F4":
	 			return 53;
	 		case "F#4":
	 			return 54;
	 		case "Gb4":
	 			return 54;
	 		case "G4":
	 			return 55;
	 		case "G#4":
	 			return 56;
	 		case "Ab4":
	 			return 56;
	 		case "A4":
	 			return 57;
	 		case "A#4":
	 			return 58;
	 		case "Bb4":
	 			return 58;
	 		case "B4":
	 			return 59;
	 		case "Cb4":
	 			return 59;
	 		case "C5":
	 			return 60;
	 		case "C#5":
	 			return 61;
	 		case "Db5":
	 			return 61;
	 		case "D5":
	 			return 62;
	 		case "D#5":
	 			return 63;
	 		case "Eb5":
	 			return 63;
	 		case "E5":
	 			return 64;
	 		case "Fb5":
	 			return 64;
	 		case "F5":
	 			return 65;
	 		case "F#5":
	 			return 66;
	 		case "Gb5":
	 			return 66;
	 		case "G5":
	 			return 67;
	 		case "G#5":
	 			return 68;
	 		case "Ab5":
	 			return 68;
	 		case "A5":
	 			return 69;
	 		case "A#5":
	 			return 70;
	 		case "Bb5":
	 			return 70;
	 		case "B5":
	 			return 71;
	 		case "Cb5":
	 			return 71;
	 	}
	 }

 	/*
	 * Inputs: midi --- the midi representation of a note
	 *
	 * Returns the string representation of the note.
	 */
	function MIDIToNote(midi) {
	 	switch (note) {
	 		case 48:
	 			return "C4";
	 		case 52:
	 			return "E4";
	 		case 55:
	 			return "G4";
	 		case 60:
	 			return "C5";
	 		case 64:
	 			return "E5";
	 		case 67:
	 			return "G5";
	 	}
	}

	 /*
	  * Draw notes on the canvas.
	  */
	function draw_note(note) {
	  // Clear the staff.
	  ctx.clear();
      var stave = new Vex.Flow.Stave(10, 0, 100);
      stave.addClef("treble").setContext(ctx).draw();
      // Convert note.
      if (note.length == 2) {
      	var new_note = new Vex.Flow.StaveNote({ keys: [note.toLowerCase().substring(0, 1) + "/" + note.substring(1, 2)], duration: "q" });
      }
	  else {
	  	var new_note = new Vex.Flow.StaveNote({ keys: [note.toLowerCase().substring(0, 2) + "/" + note.substring(2, 3)], duration: "q" });
	  }
	  var staff_notes = [];
	  // Play note.
	  if (note.length == 2) {
	    staff_notes[0] = new_note;
	  }
	  else {
	  	if (note.substring(1, 2) === "#") {
	  		staff_notes[0] = new_note.addAccidental(0, new Vex.Flow.Accidental("#"));
	  	}
	  	else {
	  		staff_notes[0] = new_note.addAccidental(0, new Vex.Flow.Accidental("b"));
	  	}
	  }
	  // Create a voice in 1/4 for now.
	  var voice = new Vex.Flow.Voice({
	    num_beats: 1,
	    beat_value: 4,
	    resolution: Vex.Flow.RESOLUTION
	  });
	  // Add notes to voice
	  voice.addTickables(staff_notes);
	  // Format and justify the notes to 500 pixels
	  var formatter = new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 500);
	  // Render voice
	  voice.draw(ctx, stave);
	}

	/*
	 * Start our machine learning.
	 */
 	function start() {
 		timer.run();
 	}

 	/*
 	 * Stop the machine learning.
 	 */
 	function stop() {
 		timer.end();
 	}

 	function reinforcement_learning(state, validActions) {
 		var nextNote = validActions[Math.floor(Math.random() * validActions.length)];
 		state.push(nextNote);
 		return nextNote;
 	}

 </script>

 <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
 <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

</head>


<body background="background.jpg">


<div class="navbar-wrapper"><!-- Wrap the .navbar in .container to center it within the absolutely positioned parent. -->
<div class="container">
<div class="navbar navbar-inverse">
<div class="navbar-inner"> 
	<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="brand" href="#">Computer Music</a> 
</div>
</div>
</div>
</div>

<div class="container">
<div class="row-fluid">
<div class="span12  offsetHalf block">
<div class="hero-unit span12">
  <br><br>
  <font color="black">

    <div id="loading">
	  <br>
	  <font size=8>Program will start soon. Data is being loaded.....</font>
	</div>

	<div id="notes">
		<canvas id="score" width="700" height="100"></canvas>
	</div>

	<div id="controls">
		<button class="btn btn-large btn-primary" type="button" onclick="start()">Start</button>
		<button class="btn btn-large btn-primary" type="button" onclick="stop()">Stop</button>
	</div>

  </font>
</div>
</div>
</div>
</div>


<script type="text/javascript">

// Which type of machine learning are we using?
// 0 = Reinforcement Learning
// 1 = Supervised Learning
var learning_method = 0;

// Which algorithm are we using?
// 0 = Reinforcement Learning (will find reinforcement subsets later)
var algorithm = 0;

// Music notation.
var canvas = $("#score")[0];
var renderer = new Vex.Flow.Renderer(canvas, Vex.Flow.Renderer.Backends.CANVAS);
var ctx = renderer.getContext();
var stave = new Vex.Flow.Stave(10, 0, 100);

// Reinforcement machine learning variables.
var notes = ["C4", "E4", "G4", "C5", "E5", "G5"];
var state = [];

var draw_canvas = function() {
	stave.addClef("treble").setContext(ctx).draw();
};

var timer = new interval(1000, function() {
	var noteName = "";
	// Get the next note via reinforcement machine learning.
	if (learning_method === 0) {
		noteName = reinforcement_learning(state, notes);
		console.log(state);
	}
	// Get the next note via supervised machine learning.
	if (learning_method === 1) {
		// Do stuff.
	}
	var note = noteToMIDI(noteName); // the MIDI note
	var velocity = 127; // how hard the note hits
	MIDI.noteOn(0, note, velocity, 0);
	draw_note(noteName);
}); 

$(window).load(function() {
	$('#controls').hide();
    MIDI.loadPlugin({
		soundfontUrl: "./soundfont/",
		instruments: [ "acoustic_grand_piano", "acoustic_grand_piano" ],
		callback: function() {
			$('#loading').remove();
			$('#controls').show();
			draw_canvas();
			//start();
		}
	});
});


</script>
</body>
</html>