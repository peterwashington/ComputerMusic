<html>

	<head>
		<title>Interactive Computer Music</title>

		<!--Vexflow-->
		<script src="js/jquery-1.6.2.min.js"></script>
		<script src="js/vexflow.js"></script>
	    <script src="bootstrap/js/bootstrap.min.js"></script>

		<link href="style.css" rel="stylesheet" type="text/css">

		<script language="javascript">

			/*
			 * Inputs: note   --- a string of the note to play, such as 'A'
			 * 		   length --- the number of seconds to play the note
			 *
			 * Plays a specified note for a certain length of time.
			 */
			function playNote(source, note, length) {
				source.frequency.value = note;
				source.start(myAudioContext.currentTime);
			}

			/*
			 * Inputs: duration --- the interval at which to call the function
			 * 		   fn       --- the function to call
			 *
			 * Replaces setTimeout() with a more accurate version.
			 */
			function interval(duration, fn) {
				this.baseline = undefined
				this.run = function() {
				    if (this.baseline === undefined) {
				    	this.baseline = new Date().getTime();
				    }
				    fn();
				    var end = new Date().getTime();
				    this.baseline += duration;
				    var nextTick = duration - (end - this.baseline);
				    if (nextTick < 0) {
				      nextTick = 0;
				    }
				    (function(i) {
				        i.timer = setTimeout(function() {
				        	i.run(end);
				      	}, nextTick)
				    }) (this)
			  	}
				this.stop = function() {
			   		clearTimeout(this.timer);
			 	}
			}

			/*
			 * Inputs: note --- the string representation of a note
			 *
			 * Returns the frequency of the note.
			 */
			 function noteToFrequency(note) {
			 	switch (note) {
			 		case "C4":
			 			return 261.63;
			 		case "C#4":
			 			return 277.18;
			 		case "Db4":
			 			return 277.18;
			 		case "D4":
			 			return 293.66;
			 		case "D#4":
			 			return 311.13;
			 		case "Eb4":
			 			return 311.13;
			 		case "E4":
			 			return 329.63;
			 		case "Fb4":
			 			return 329.63;
			 		case "F4":
			 			return 349.23;
			 		case "F#4":
			 			return 369.99;
			 		case "Gb4":
			 			return 369.99;
			 		case "G4":
			 			return 392.00;
			 		case "G#4":
			 			return 415.30;
			 		case "Ab4":
			 			return 415.30;
			 		case "A4":
			 			return 440.00;
			 		case "A#4":
			 			return 466.16;
			 		case "Bb4":
			 			return 466.16;
			 		case "B4":
			 			return 493.88;
			 		case "Cb4":
			 			return 493.88;
			 		case "C5":
			 			return 523.25;
			 		case "C#5":
			 			return 554.37;
			 		case "Db5":
			 			return 554.37;
			 		case "D5":
			 			return 587.33;
			 		case "D#5":
			 			return 622.25;
			 		case "Eb5":
			 			return 622.25;
			 		case "E5":
			 			return 659.26;
			 		case "Fb5":
			 			return 659.26;
			 		case "F5":
			 			return 698.46;
			 		case "F#5":
			 			return 739.99;
			 		case "Gb5":
			 			return 739.99;
			 		case "G5":
			 			return 783.99;
			 		case "G#5":
			 			return 830.61;
			 		case "Ab5":
			 			return 830.61;
			 		case "A5":
			 			return 880.00;
			 		case "A#5":
			 			return 932.33;
			 		case "Bb5":
			 			return 932.33;
			 		case "B5":
			 			return 987.77;
			 		case "Cb5":
			 			return 987.77;
			 	}
			 }

			 /*
			  * Start the music.
			  */
			 function start() {
			 	timer.run();
		    	timer2.run();
			 }

			 /*
			  *Change the chord to A.
			  */
			 function a_chord() {
			 	chord = "A";
			 }

			 /*
			  *Change the chord to D.
			  */
			 function d_chord() {
			 	chord = "D";
			 }

			 /*
			  *Change the chord to E.
			  */
			 function e_chord() {
			 	chord = "E";
			 }

			 /*
			  * Draw notes on the canvas.
			  */
			function draw_note(note) {
			  // Clear the staff.
			  ctx.clear();
		      var stave = new Vex.Flow.Stave(10, 0, 100);
		      stave.addClef("treble").setContext(ctx).draw();
		      // Convert note.
		      if (note.length == 2) {
		      	var new_note = new Vex.Flow.StaveNote({ keys: [note.toLowerCase().substring(0, 1) + "/" + note.substring(1, 2)], duration: "q" });
		      }
			  else {
			  	var new_note = new Vex.Flow.StaveNote({ keys: [note.toLowerCase().substring(0, 2) + "/" + note.substring(2, 3)], duration: "q" });
			  }
			  var staff_notes = [];
			  // Play note.
			  if (note.length == 2) {
			    staff_notes[0] = new_note;
			  }
			  else {
			  	if (note.substring(1, 2) === "#") {
			  		staff_notes[0] = new_note.addAccidental(0, new Vex.Flow.Accidental("#"));
			  	}
			  	else {
			  		staff_notes[0] = new_note.addAccidental(0, new Vex.Flow.Accidental("b"));
			  	}
			  }
			  // Create a voice in 1/4 for now.
			  var voice = new Vex.Flow.Voice({
			    num_beats: 1,
			    beat_value: 4,
			    resolution: Vex.Flow.RESOLUTION
			  });
			  // Add notes to voice
			  voice.addTickables(staff_notes);
			  // Format and justify the notes to 500 pixels
			  var formatter = new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 500);
			  // Render voice
			  voice.draw(ctx, stave);
			}


		</script>

		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">

	</head>

	<body>

	    <script langugae="javascript">

	    </script>

	    <h1>Interactive Computer Music</h1>

		<br>

	    <div class="hero-unit">

	    	<p id="textelement">Note: </p>
	    	<canvas id="score" width="700" height="100"></canvas>
	    	<br>
	    	Volume<br>
	    	<input id="volume" type="range" min="0.0" max="0.1" step="0.001" value="0.05"/>
	    	<br>
			<button class="btn btn-large btn-primary" type="button" onclick="start()">Start</button>
			<button class="btn btn-large btn-primary" type="button" onclick="a_chord()">A Chord</button>
			<button class="btn btn-large btn-primary" type="button" onclick="d_chord()">D Chord</button>
			<button class="btn btn-large btn-primary" type="button" onclick="e_chord()">E Chord</button>
		</div>

		<br>

		&nbsp;&nbsp;A project by Peter Washington at Rice University.

		<script langugae="javascript">

			if ('webkitAudioContext' in window) {
	    		var myAudioContext = new webkitAudioContext();
			}
			else {
				alert("Sorry - this app requires an updated version of Chrome or Safari!");
			}

			var notesA = ["C#4", "E4", "A5", "C#5", "E5"];
			var notesD = ["F#4", "A4", "D5", "F#5", "A5"];
			var notesE = ["G#4", "B4", "E5", "G#5", "B5"];

			var chord = "A";

			// Initialization
			var gainNode = myAudioContext.createGainNode();
			var source1 = myAudioContext.createOscillator();
			source1.type = 2; 
			var source2 = myAudioContext.createOscillator();
			source2.type = 2; 
			source1.connect(gainNode);
			source2.connect(gainNode);
			gainNode.gain.value = 0.05;
			gainNode.connect(myAudioContext.destination); 
			var ticks = 0;

			// NEW INITIALIZATION

			document.getElementById('volume').addEventListener('change', function() {
			    gainNode.gain.value = this.value;
			});

			var timer = new interval(1000, function() {
				var note1 = "";
				var note2 = "";
				if (chord === "A") {
					note1 = notesA[Math.floor(Math.random() * notesA.length)];
					note2 = "A4";
				}
				else if (chord === "D") {
					note1 = notesD[Math.floor(Math.random() * notesD.length)];
					note2 = "D4";
				}
				else if (chord === "E") {
					note1 = notesE[Math.floor(Math.random() * notesE.length)];
					note2 = "E4";
				}
				else {
					note1 = notesA[Math.floor(Math.random() * notesA.length)];
					note2 = "A4";
				}
		    	playNote(source1, noteToFrequency(note1), 1);
		    	playNote(source2, noteToFrequency(note2), 1);
		    	document.getElementById("textelement").innerHTML = "Melody note: " + note1;
		    	draw_note(note1);
		    	ticks += 1;
		    });

		    var timer2 = new interval(1000, function() {
		    	// Other things here...eventually.
		    }); 

		    // Music notation.
		    var canvas = $("#score")[0];
		    var renderer = new Vex.Flow.Renderer(canvas, Vex.Flow.Renderer.Backends.CANVAS);
		    var ctx = renderer.getContext();
		    var stave = new Vex.Flow.Stave(10, 0, 100);
		    stave.addClef("treble").setContext(ctx).draw();

		</script>

	</body>

</html>